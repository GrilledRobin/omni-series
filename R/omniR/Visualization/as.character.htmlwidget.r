#---------------------------------------------------------------------------------------------------------------------------------------#
#100.   Introduction.                                                                                                                   #
#---------------------------------------------------------------------------------------------------------------------------------------#
#   |This function is intended to convert an [htmlwidget] into character vector                                                         #
#   |-----------------------------------------------------------------------------------------------------------------------------------#
#   |[Quote]                                                                                                                            #
#   |-----------------------------------------------------------------------------------------------------------------------------------#
#   |[01] https://github.com/rstudio/DT/issues/410                                                                                      #
#   |-----------------------------------------------------------------------------------------------------------------------------------#
#   |[IMPORTANT]                                                                                                                        #
#   |-----------------------------------------------------------------------------------------------------------------------------------#
#   |[01] This is the very first among the helper functions that enables one to insert [htmlwidget] into cells of [DT::datatable]       #
#   |-----------------------------------------------------------------------------------------------------------------------------------#
#   |[Method to insert htmlwidgets into datatable]                                                                                      #
#   |-----------------------------------------------------------------------------------------------------------------------------------#
#   |[10] Convert htmlwidget into character version; using function [as.character.htmlwidget]                                           #
#   |[20] Make sure [escape = FALSE]                                                                                                    #
#   |[30] Add static render callback; using function [add_datatable_render_code]                                                        #
#   |[40] Add dependencies for the htmlwidget being used; using function [add_deps]                                                     #
#---------------------------------------------------------------------------------------------------------------------------------------#
#200.   Glossary.                                                                                                                       #
#---------------------------------------------------------------------------------------------------------------------------------------#
#   |100.   Parameters.                                                                                                                 #
#   |-----------------------------------------------------------------------------------------------------------------------------------#
#   |x           :   The [htmlwidget] to convert. Call [class(x)] to see if it is [htmlwidget].                                         #
#   |...         :   See document for [htmltools:::as.character.shiny.tag.list]                                                         #
#   |-----------------------------------------------------------------------------------------------------------------------------------#
#   |900.   Return Values by position.                                                                                                  #
#   |-----------------------------------------------------------------------------------------------------------------------------------#
#   |<vec>       :   Character vector the represents the translated html tags of the widget                                             #
#---------------------------------------------------------------------------------------------------------------------------------------#
#300.   Update log.                                                                                                                     #
#---------------------------------------------------------------------------------------------------------------------------------------#
#   | Date |    20211208        | Version | 1.00        | Updater/Creator | Lu Robin Bin                                                #
#   |______|____________________|_________|_____________|_________________|_____________________________________________________________#
#   | Log  |Version 1.                                                                                                                  #
#   |______|____________________________________________________________________________________________________________________________#
#---------------------------------------------------------------------------------------------------------------------------------------#
#400.   User Manual.                                                                                                                    #
#---------------------------------------------------------------------------------------------------------------------------------------#
#   |See the [Full Test Program] section                                                                                                #
#---------------------------------------------------------------------------------------------------------------------------------------#
#500.   Dependent Facilities.                                                                                                           #
#---------------------------------------------------------------------------------------------------------------------------------------#
#   |100.   Dependent Modules                                                                                                           #
#   |-----------------------------------------------------------------------------------------------------------------------------------#
#   |   |htmltools, htmlwidgets                                                                                                         #
#   |-----------------------------------------------------------------------------------------------------------------------------------#
#   |300.   Dependent functions                                                                                                         #
#   |-----------------------------------------------------------------------------------------------------------------------------------#
#---------------------------------------------------------------------------------------------------------------------------------------#

#001. Append the list of required packages to the global environment
#Below expression is used for easy copy-paste from raw text strings instead of quoted ones.
lst_pkg <- deparse(substitute(c(
	htmltools, htmlwidgets
)))
#Quote: https://www.regular-expressions.info/posixbrackets.html?wlr=1
lst_pkg <- paste0(lst_pkg, collapse = '')
lst_pkg <- gsub('[[:space:]]', '', lst_pkg, perl = T)
lst_pkg <- gsub('^c\\((.+)\\)', '\\1', lst_pkg, perl = T)
lst_pkg <- unlist(strsplit(lst_pkg, ',', perl = T))
options( omniR.req.pkg = base::union(getOption('omniR.req.pkg'), lst_pkg) )

as.character.htmlwidget <- function(x, ...) {
	htmltools::HTML(
		htmltools:::as.character.shiny.tag.list(
			htmlwidgets:::as.tags.htmlwidget(
				x
			)
			,...
		)
	)
}

#[Full Test Program;]
if (FALSE){
	#Real case test
	if (TRUE){
		#100. Prepare the [echarts4r] widget, which is essentially [htmlwidget]. Check its [class] for information
		ech_bar <- mtcars |>
			tibble::rownames_to_column('model') |>
			dplyr::mutate(total = mpg + qsec) |>
			dplyr::arrange(desc(total)) |>
			echarts4r::e_charts(model) |>
			echarts4r::e_bar(mpg, stack = 'grp') |>
			echarts4r::e_bar(qsec, stack = 'grp')

		#200. Convert it into html tags as character vector
		v_bar <- as.character.htmlwidget(ech_bar)

	}
}
